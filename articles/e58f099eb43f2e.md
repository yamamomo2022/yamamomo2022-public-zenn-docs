---
title: "FlutterアプリがApp Store審査でGuideline 5.1.1によりリジェクトされた話"
emoji: "🐷"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Flutter", "iOS", "AppStore", "アプリ開発", "個人開発"]
published: false
---

# FlutterアプリがApp Store審査でGuideline 5.1.1によりリジェクトされた話

こんにちは！今回は私がスキルアップを目的として個人開発したFlutterアプリがApp Store審査において「Guideline 5.1.1 - Legal - Privacy - Data Collection and Storage」という理由でリジェクトされた経験と、その解決方法について共有します。

## 個人開発の背景

このアプリは純粋にFlutterとAI技術の学習を目的とした個人開発プロジェクトです。普段の業務ではネイティブアプリ開発に携わる機会が少なかったため、クロスプラットフォーム開発の技術習得と最新のAI APIを活用したアプリ開発のプロセスを一通り経験することが目標でした。

個人開発ならではの「自由度の高さ」と「リソース制約」の中で開発を進め、特にAIチャット機能の実装に力を入れました。それだけに、せっかく作ったアプリがApp Store審査でリジェクトされたときは少なからずショックを受けましたが、この経験から学べることも多かったです。

## リジェクトの内容

App Store Connect上で審査結果の通知を確認すると、以下のようなメッセージが表示されていました：

```
Guideline 5.1.1 - Legal - Privacy - Data Collection and Storage

Issue Description

The app requires users to register or log in to access features that are not account based.

Specifically, the app requires users to register before accessing AI feature. Apps may not require users to enter personal information to function, except when directly relevant to the core functionality of the app or required by law.

Next Steps

Revise the app to let users freely access the app's features that are not account based.

Resources

Learn more about requirements for apps with account-based content and features in guideline 5.1.1(v) - Account Sign-In.
```

要するに「アカウントベースではない機能（AIの機能）にアクセスするために、ユーザー登録を要求している」という理由でリジェクトされたのです。

## Guideline 5.1.1とは？

Apple App Store Guidelineの5.1.1は、プライバシーとデータ収集に関する要件を定めています。その中でも今回問題となったのは、アカウント登録に関する部分です。主な内容は：

1. アプリはアカウントベースではない機能に対して、ユーザー登録やログインを要求してはならない
2. ユーザーの個人情報は、アプリのコア機能に直接関連する場合や法律で要求される場合を除き、要求してはならない
3. 登録が必要な機能と不要な機能を明確に分けるべき

## なぜリジェクトされたのか？

私の個人開発アプリの場合、以下の理由からリジェクトされました：

1. アプリ内のAI機能を使用するために、ユーザー登録が必須となっていた
2. しかし、そのAI機能はアカウントに紐づく必要がない機能だった
3. アプリ内のすべての機能（AI機能を含む）を使用するために認証を要求していた

実は個人開発の場合、認証機能の実装自体がスキルアップの一環として重要だったため、アプリのすべての機能をログイン後に使用できるシンプルな設計にしていました。これはコードの管理や状態管理の学習としては効率的でしたが、Appleの観点では、アカウントに紐づく必要のない機能には自由にアクセスできるようにすべきという考えなのです。

## 具体的な問題点の分析

私のアプリでは、以下のような実装が問題となっていました：

```dart
class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      home: AuthenticationWrapper(),
    );
  }
}

class AuthenticationWrapper extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final user = Provider.of<User?>(context);
    
    // ユーザーがログインしていない場合はログイン画面に誘導
    if (user == null) {
      return LoginScreen();
    }
    
    // ログイン済みの場合はホーム画面を表示
    return HomeScreen();
  }
}
```

このコードでは、アプリを開いたときに認証状態をチェックし、未ログインの場合は必ずログイン画面に誘導しています。AIチャット機能など、アカウントに紐づく必要のない機能も含めてすべての機能にログインを要求していたのが問題でした。

## 解決方法

個人開発のスキルアップ目的のアプリとしては、リジェクト内容を受けて新たな学びを得るチャンスだと捉え、「おためし機能」を導入するアプローチを採用しました。以下のステップで対応しました：

### 1. 機能の分類と制限設計

まず、アプリの機能を以下のように分類しました：

1. **アカウントが必須の機能（フル機能）**：
   - ユーザープロフィールの表示・編集
   - 履歴の保存や同期
   - カスタマイズ設定の保存
   - 高度なAI機能（複雑なプロンプトや長文生成など）

2. **おためし機能（ログインなし）**：
   - 基本的なAIチャット機能（制限付き）
   - 基本的な情報表示
   - アプリの使い方ガイド

特に重要なのは、AIチャット機能に関しては「おためし版」と「フル機能版」を明確に分けることでした。おためし版では使用回数や機能に一定の制限を設けながらも、アプリの核となる機能を体験できるようにしました。

### 2. アプリフローの再設計

次に、アプリのフローを再設計し、ログインなしでも「おためし機能」にアクセスできるようにしました：

```dart
class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      home: MainScreen(), // 認証に関係なく最初に表示される画面
    );
  }
}

class MainScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final user = Provider.of<User?>(context);
    final bool isLoggedIn = user != null;
    
    return Scaffold(
      appBar: AppBar(
        title: Text('My App'),
        actions: [
          // ログインボタンまたはプロフィールボタンを表示
          isLoggedIn
            ? IconButton(
                icon: Icon(Icons.person),
                onPressed: () => Navigator.push(
                  context, 
                  MaterialPageRoute(builder: (_) => ProfileScreen())
                ),
              )
            : IconButton(
                icon: Icon(Icons.login),
                onPressed: () => Navigator.push(
                  context, 
                  MaterialPageRoute(builder: (_) => LoginScreen())
                ),
              ),
        ],
      ),
      body: isLoggedIn ? HomeContent() : TrialHomeContent(), // ログイン状態によって表示内容を変更
      bottomNavigationBar: BottomNavigationBar(
        items: [
          BottomNavigationBarItem(icon: Icon(Icons.home), label: 'ホーム'),
          BottomNavigationBarItem(
            icon: Icon(Icons.chat), 
            label: isLoggedIn ? 'AIチャット' : 'AIチャット（おためし）'
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.settings), 
            label: 'アカウント'
          ),
        ],
        onTap: (index) {
          if (index == 0) {
            // ホーム画面
            // ...
          } else if (index == 1) {
            // AIチャット画面
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (_) => AIChatScreen(isTrial: !isLoggedIn)
              ),
            );
          } else if (index == 2) {
            // アカウント画面
            if (isLoggedIn) {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (_) => AccountScreen()),
              );
            } else {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (_) => LoginOrTrialScreen()),
              );
            }
          }
        },
      ),
    );
  }
}
```

### 3. AIチャット機能におためし版の実装

リジェクト理由となったAIチャット機能については、以下のようにおためし版とフル機能版を実装しました：

```dart
class AIChatScreen extends StatelessWidget {
  final bool isTrial;
  
  const AIChatScreen({Key? key, required this.isTrial}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(isTrial ? 'AIチャット（おためし）' : 'AIチャット'),
        actions: [
          if (isTrial)
            TextButton.icon(
              icon: Icon(Icons.upgrade),
              label: Text('フル機能へ'),
              onPressed: () => _showUpgradeDialog(context),
            ),
        ],
      ),
      body: Column(
        children: [
          // 制限表示（おためし版の場合のみ）
          if (isTrial)
            Container(
              padding: EdgeInsets.all(8),
              color: Colors.amber.shade100,
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    'おためし版の制限：',
                    style: TextStyle(fontWeight: FontWeight.bold),
                  ),
                  Text('• 1日5回までの質問'),
                  Text('• 回答は150文字まで'),
                  Text('• 会話履歴は保存されません'),
                  SizedBox(height: 8),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.end,
                    children: [
                      TextButton(
                        child: Text('アカウント登録'),
                        onPressed: () => Navigator.push(
                          context,
                          MaterialPageRoute(builder: (_) => RegisterScreen()),
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          
          // チャット履歴などが表示されるコンテンツ
          Expanded(
            child: ChatContent(isTrial: isTrial),
          ),
          
          // メッセージ入力欄
          Padding(
            padding: EdgeInsets.all(8),
            child: Row(
              children: [
                Expanded(
                  child: TextField(
                    decoration: InputDecoration(
                      hintText: 'メッセージを入力...',
                      border: OutlineInputBorder(),
                    ),
                  ),
                ),
                IconButton(
                  icon: Icon(Icons.send),
                  onPressed: () {
                    // メッセージ送信処理
                    // おためし版の場合は制限をチェック
                    if (isTrial) {
                      _checkTrialLimits(context);
                    } else {
                      // 通常の送信処理
                    }
                  },
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
  
  void _showUpgradeDialog(BuildContext context) {
    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: Text('フル機能版へアップグレード'),
        content: Text('アカウント登録をすると以下の機能が利用できるようになります：\n'
            '• 無制限の質問回数\n'
            '• 長文での回答\n'
            '• 会話履歴の保存\n'
            '• 高度なAI機能'),
        actions: [
          TextButton(
            child: Text('キャンセル'),
            onPressed: () => Navigator.pop(context),
          ),
          TextButton(
            child: Text('登録する'),
            onPressed: () {
              Navigator.pop(context);
              Navigator.push(
                context,
                MaterialPageRoute(builder: (_) => RegisterScreen()),
              );
            },
          ),
        ],
      ),
    );
  }
  
  void _checkTrialLimits(BuildContext context) {
    // おためし版の制限チェック
    // 実際にはローカルストレージなどで使用回数を保存して制限を実装
    // ...
  }
}
```

### 4. おためし版の制限実装

おためし版には以下のような制限を設け、ユーザーに明示的に表示しました：

1. **使用回数の制限**：1日あたりの質問回数を5回までに制限
2. **機能の制限**：回答文字数制限（150文字まで）や特定の高度な機能を無効化
3. **履歴の非保存**：チャット履歴をセッション終了後に保持しない

これらの制限は`SharedPreferences`などを使用して実装しました：

```dart
class TrialLimitManager {
  static const String _keyDailyCount = 'trial_daily_count';
  static const String _keyLastDate = 'trial_last_date';
  static const int maxDailyQuestions = 5;
  
  // おためし版の使用回数をチェック
  static Future<bool> canAskQuestion() async {
    final prefs = await SharedPreferences.getInstance();
    final String today = DateTime.now().toIso8601String().split('T')[0];
    final String lastDate = prefs.getString(_keyLastDate) ?? '';
    
    // 日付が変わった場合はカウントをリセット
    if (lastDate != today) {
      await prefs.setString(_keyLastDate, today);
      await prefs.setInt(_keyDailyCount, 0);
    }
    
    final int count = prefs.getInt(_keyDailyCount) ?? 0;
    return count < maxDailyQuestions;
  }
  
  // 質問カウントを増やす
  static Future<void> incrementQuestionCount() async {
    final prefs = await SharedPreferences.getInstance();
    final String today = DateTime.now().toIso8601String().split('T')[0];
    final String lastDate = prefs.getString(_keyLastDate) ?? '';
    
    if (lastDate != today) {
      await prefs.setString(_keyLastDate, today);
      await prefs.setInt(_keyDailyCount, 1);
    } else {
      final int count = prefs.getInt(_keyDailyCount) ?? 0;
      await prefs.setInt(_keyDailyCount, count + 1);
    }
  }
  
  // 残りの質問回数を取得
  static Future<int> getRemainingQuestions() async {
    final prefs = await SharedPreferences.getInstance();
    final String today = DateTime.now().toIso8601String().split('T')[0];
    final String lastDate = prefs.getString(_keyLastDate) ?? '';
    
    if (lastDate != today) {
      return maxDailyQuestions;
    }
    
    final int count = prefs.getInt(_keyDailyCount) ?? 0;
    return maxDailyQuestions - count;
  }
}
```

### 5. ユーザーへの明確な価値提案

個人開発アプリとしては、ユーザー獲得よりも学習が主目的でしたが、せっかくならユーザー体験も向上させたいと考え、おためし版とフル機能版の違いをユーザーに明確に伝えるため、以下の対応を行いました：

- アプリ内での明示的な「おためし版」表示
- 制限に達した際の明確なメッセージとアップグレード案内
- 登録することで得られるメリットの具体的な説明

## 再審査と承認

上記の変更を行った後、アプリを再提出したところ、無事に審査を通過しました。「おためし機能」を導入することで、ユーザーはアカウント登録なしでもアプリの核となる機能を体験できるようになり、Appleのガイドラインを満たすことができました。

個人開発プロジェクトとしては、当初計画していなかった「フリーミアムモデル」の設計と実装も経験できたことが、貴重な学びとなりました。

## まとめ

1. アプリのコア機能（AIチャット）に「おためし版」を導入し、登録なしでも使用可能にする
2. おためし版には適切な制限を設け、フル機能版へのアップグレード誘導を自然に行う
3. 制限内容とアップグレードのメリットをユーザーに明確に伝える
4. 登録はユーザーの任意選択とし、強制しない

この記事が、同じような問題に直面している方、特に個人開発やスキルアップを目的としたアプリ開発に取り組んでいる方の参考になれば幸いです。「おためし機能」の導入は、App Storeのガイドラインを満たしながらも、ユーザー獲得とエンゲージメント向上の両方を実現する有効な戦略であり、個人開発者にとっても比較的取り組みやすい対応策です。

また、個人開発でアプリストアに公開する際は、審査ガイドラインを事前によく確認しておくことが、無駄な時間を省くためにも重要だと実感しました。

## 参考リンク

- [App Store Review Guidelines - Apple Developer](https://developer.apple.com/app-store/review/guidelines/)
- [Account-Based Apps - App Store Review Guidelines](https://developer.apple.com/app-store/review/guidelines/#5.1.1)
- [User Privacy and Data Use - Apple Developer](https://developer.apple.com/app-store/user-privacy-and-data-use/)
